<% seller = @listing.user %>
<% seller_name = seller&.full_name.presence || seller&.username || "Seller" %>

<div class="mx-auto mt-8 w-full max-w-6xl">
  <div class="mb-4">
    <% back_params = params.permit(:page, :q).to_h.compact_blank %>
    <%= link_to listings_path(back_params),
                class: "inline-flex items-center gap-2 text-sm font-semibold text-blue-600 transition hover:text-blue-700" do %>
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
        <path fill-rule="evenodd" d="M11.78 4.22a.75.75 0 010 1.06L8.06 9l3.72 3.72a.75.75 0 11-1.06 1.06l-4.25-4.25a.75.75 0 010-1.06l4.25-4.25a.75.75 0 011.06 0z" clip-rule="evenodd" />
      </svg>
      <span>Back to all listings</span>
    <% end %>
  </div>

  <div class="grid grid-cols-1 gap-6 lg:grid-cols-3 lg:items-start">
    <article class="flex flex-col overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-gray-100 lg:col-span-2">
      <div class="bg-gray-100">
        <% if defined?(ActiveStorage) && @listing.respond_to?(:image) && @listing.image.respond_to?(:attached?) && @listing.image.attached? %>
          <%= image_tag @listing.image.variant(resize_to_fill: [ 900, 700 ]),
                        alt: @listing.title,
                        class: "h-64 w-full object-cover sm:h-80 lg:h-[28rem]" %>
        <% elsif @listing.respond_to?(:image_url) && @listing.image_url.present? %>
          <%= image_tag @listing.image_url,
                        alt: @listing.title,
                        class: "h-64 w-full object-cover sm:h-80 lg:h-[28rem]" %>
        <% else %>
          <div class="flex h-64 w-full items-center justify-center bg-gray-200 sm:h-80 lg:h-[28rem]">
            <svg class="text-gray-400" role="img" aria-label="No image" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="80" height="80" focusable="false">
              <path fill="currentColor" d="M3 7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7zm5 2l2.5 3 1.5-2L15 15H5l3-6z"/>
            </svg>
          </div>
        <% end %>
      </div>

      <div class="space-y-6 p-6">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
          <h1 class="text-2xl font-semibold text-gray-900 leading-tight"><%= @listing.title %></h1>
          <div class="text-2xl font-bold text-green-600"><%= number_to_currency(@listing.price || 0) %></div>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <% if @listing.user == current_user %>
            <span class="inline-flex items-center gap-2 rounded-full bg-blue-50 px-3 py-1 text-sm font-semibold text-blue-700 ring-1 ring-blue-200">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4 text-blue-600">
                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
              </svg>
              <%= pluralize(@listing.favorites_count, "like") %>
            </span>
          <% elsif authenticated? %>
            <% liked = current_user.liked?(@listing) %>
            <% if liked %>
              <%= link_to favorite_path(@listing),
                          data: { turbo_method: :delete },
                          class: "inline-flex items-center gap-2 rounded-md border border-blue-600 bg-blue-50 px-3 py-2 text-sm font-semibold text-blue-700 shadow-sm transition hover:bg-blue-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-1" do %>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5 text-blue-600">
                  <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" />
                </svg>
                <span>Liked</span>
              <% end %>
            <% else %>
              <%= link_to favorites_path(listing_id: @listing.id),
                          data: { turbo_method: :post },
                          class: "inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm transition hover:bg-gray-50 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-1" do %>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="none" stroke="currentColor" class="h-5 w-5 text-gray-500">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" />
                </svg>
                <span>Like</span>
              <% end %>
            <% end %>
          <% end %>
        </div>

        <div class="prose prose-sm max-w-none text-gray-700">
          <%= simple_format(@listing.description) %>
        </div>

        <div class="grid gap-4 rounded-xl bg-gray-50 px-4 py-3 text-sm text-gray-600 sm:grid-cols-2">
          <div>
            <span class="font-semibold text-gray-800">Seller</span>
            <div class="mt-1 text-gray-900"><%= seller_name %></div>
          </div>
          <div>
            <span class="font-semibold text-gray-800">Posted</span>
            <div class="mt-1 text-gray-900"><%= @listing.created_at.strftime("%B %d, %Y") %></div>
          </div>
        </div>
      </div>
    </article>

    <% if seller.present? %>
      <aside class="h-full space-y-6 rounded-2xl border border-blue-100 bg-blue-50 p-6 shadow-sm lg:col-span-1 lg:self-start">
        <h2 class="text-lg font-semibold text-blue-900">Contact information</h2>
        <dl class="mt-4 space-y-4 text-sm">
          <div class="flex flex-col">
            <dt class="text-xs font-semibold uppercase tracking-wide text-blue-800">Name</dt>
            <dd class="mt-1 text-base font-semibold text-blue-900"><%= seller_name %></dd>
          </div>
          <div class="flex flex-col">
            <dt class="text-xs font-semibold uppercase tracking-wide text-blue-800">Email</dt>
            <dd class="mt-1">
              <%= mail_to seller.email_address,
                          seller.email_address,
                          class: "text-base font-semibold text-blue-900 underline decoration-blue-300 underline-offset-4 hover:text-blue-700" %>
            </dd>
          </div>
          <% if seller.phone_number.present? %>
            <div class="flex flex-col">
              <dt class="text-xs font-semibold uppercase tracking-wide text-blue-800">Phone</dt>
              <dd class="mt-1">
                <%= link_to seller.phone_number,
                            "tel:#{seller.phone_number}",
                            class: "text-base font-semibold text-blue-900 underline decoration-blue-300 underline-offset-4 hover:text-blue-700" %>
              </dd>
            </div>
          <% end %>
        </dl>

        <% if current_user.present? %>
          <% if current_user != @listing.user %>
            <%= render "bids/new_bid_form", listing: @listing, existing_bid: @existing_bid %>
          <% elsif current_user == @listing.user %>
            <%= render "bids/seller_responses", bids: (@incoming_bids || []) %>
          <% end %>
        <% end %>
      </aside>
    <% end %>
  </div>
</div>
