<%= form_with(model: listing,
              class: "space-y-8 text-base",
              data: {
                controller: "image-description",
                image_description_generate_url_value: generate_description_listings_path
              }) do |form| %>
  <% if listing.errors.any? %>
    <div role="alert" class="rounded border-l-4 border-red-500 bg-red-100 p-4 text-red-700">
      <p class="font-bold"><%= pluralize(listing.errors.count, "error") %> prohibited this listing from being saved:</p>
      <ul class="mt-2 list-disc list-inside text-sm">
        <% listing.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="space-y-8">
    <div class="space-y-2">
      <%= form.label :title, class: "block text-base font-semibold text-gray-800" %>
      <%= form.text_field :title,
                          class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base",
                          placeholder: "What are you selling?",
                          maxlength: 50,
                          required: true %>
    </div>

    <div class="space-y-2">
      <%= form.label :description, class: "block text-base font-semibold text-gray-800" %>
      <%= form.text_area :description,
                         rows: 4,
                         class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base",
                         placeholder: "Upload an image to auto-generate a description, or write your own.",
                         maxlength: 1000,
                         required: true,
                         data: { image_description_target: "descriptionField" } %>
      <div class="flex flex-wrap items-center justify-between text-sm text-gray-600">
        <p>AI will auto-generate this when you upload an image.</p>
        <button type="button"
                class="text-sm text-indigo-600 hover:text-indigo-800 underline hidden"
                data-image-description-target="generateButton"
                data-action="click->image-description#regenerate">
          â†» Regenerate with AI
        </button>
      </div>
      <p class="mt-1 text-sm hidden" data-image-description-target="statusMessage"></p>
    </div>

    <div class="space-y-2">
      <%= form.label :price, class: "block text-base font-semibold text-gray-800" %>
      <div class="relative rounded-md shadow-sm">
        <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
          <span class="text-gray-500 text-base">$</span>
        </div>
        <%= form.number_field :price,
                               class: "block w-full rounded-md border-gray-300 pl-7 pr-12 focus:border-indigo-500 focus:ring-indigo-500 text-base",
                               step: "0.01",
                               min: 0,
                               placeholder: "20.00",
                               required: true %>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
          <span class="text-gray-500 text-base" id="price-currency">USD</span>
        </div>
      </div>
    </div>

    <div class="space-y-2">
      <%= form.label :category, class: "block text-base font-semibold text-gray-800" %>
      <%= form.select :category,
                      Listing.categories.keys.map { |category| [category.titleize, category] },
                      {},
                      class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-base",
                      required: true,
                      data: { "image-description-target": "categoryField" } %>
    </div>

    <div class="space-y-2">
      <%= form.label :image, class: "block text-base font-semibold text-gray-800" %>
      <%= form.file_field :image,
                          class: "block w-full text-base text-gray-600 file:mr-4 file:rounded-md file:border-0 file:bg-gray-100 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-gray-700 hover:file:bg-gray-200",
                          accept: "image/png,image/jpeg",
                          direct_upload: true,
                          required: !listing.image.attached?,
                          data: {
                            image_description_target: "imageInput"
                          } %>
      <p class="text-sm text-gray-500">Upload a JPEG or PNG under 5MB. AI will analyze it and suggest a description.</p>
      <% if listing.image.attached? && listing.image.variable? %>
        <div class="pt-2">
          <%= image_tag listing.image.variant(resize_to_limit: [ 150, 150 ]), class: "h-24 w-24 rounded-md object-cover" %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="flex items-center justify-end gap-4 border-t border-gray-200 pt-6 text-base">
    <%= link_to "Back", listings_path, class: "rounded-md bg-white px-4 py-2 font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" %>
    <%= form.submit listing.persisted? ? "Update Listing" : "Create Listing", class: "inline-flex justify-center rounded-md border border-transparent bg-indigo-600 px-5 py-2 font-semibold text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2" %>
  </div>
<% end %>
